<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擬真語音互動測驗：The Mystery of the Sailing Stones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti Library for Celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
        }
        
        /* Smooth Highlighting for Karaoke Mode */
        .highlight-text {
            background-color: #fef3c7; /* amber-100 */
            color: #d97706; /* amber-600 */
            padding: 2px 4px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .quiz-option:hover:not(.disabled) {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .quiz-option.correct {
            background-color: #ecfdf5 !important;
            border-color: #10b981 !important;
            color: #065f46;
        }
        .quiz-option.wrong {
            background-color: #fef2f2 !important;
            border-color: #ef4444 !important;
            color: #991b1b;
            opacity: 0.8;
        }
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 10px;
            font-size: 0.95em;
            color: #4b5563;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
            background-color: #f8fafc;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Interactive Vocabulary Styles */
        .vocab-word {
            border-bottom: 2px dotted #818cf8;
            cursor: help;
            transition: all 0.2s;
            position: relative;
            color: #1e40af;
        }
        .vocab-word:hover {
            background-color: #e0e7ff;
            color: #1e3a8a;
        }

        /* Tooltip Style */
        .vocab-tooltip {
            visibility: hidden;
            width: max-content;
            min-width: 120px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 100;
            bottom: 140%; /* Position above */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            font-size: 0.9rem;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            line-height: 1.4;
        }
        .vocab-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .vocab-word:hover .vocab-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        
        /* POS Tag Style in Tooltip */
        .pos-tag {
            font-size: 0.75em;
            text-transform: uppercase;
            background-color: #4f46e5;
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 6px;
            font-weight: bold;
            color: #e0e7ff;
        }
        
        /* Audio Wave Animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 2px;
        }
        .bar {
            width: 4px;
            background: #fff;
            animation: bounce 0ms infinite ease-in-out alternate;
        }
        .playing .bar {
            animation-duration: 400ms;
        }
        .playing .bar:nth-child(1) { animation-delay: -0.2s; }
        .playing .bar:nth-child(2) { animation-delay: -0.4s; }
        .playing .bar:nth-child(3) { animation-delay: -0.6s; }
        .playing .bar:nth-child(4) { animation-delay: -0.8s; }
        @keyframes bounce {
            0% { height: 3px; opacity: 0.5; }
            100% { height: 20px; opacity: 1; }
        }
        
        .hidden-content {
            filter: blur(12px);
            user-select: none;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-12">

    <!-- Navbar / Audio Player Sticky Header -->
    <div class="sticky top-0 z-50 bg-indigo-700 text-white shadow-xl transition-all duration-300" id="audio-player-bar">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                
                <!-- Left: Title & Status -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white">
                            <i class="fas fa-headphones-alt text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-sm font-bold text-indigo-100 uppercase tracking-wide">Listening Quiz</h1>
                            <div class="text-xs text-indigo-200 flex items-center gap-1" id="voice-indicator">
                                <i class="fas fa-robot"></i> Initializing Voice...
                            </div>
                        </div>
                    </div>
                    <!-- Mobile Play Button -->
                    <button onclick="togglePlay()" class="md:hidden w-10 h-10 bg-white text-indigo-700 rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition">
                        <i class="fas fa-play" id="mobile-play-icon"></i>
                    </button>
                </div>

                <!-- Center: Controls -->
                <div class="flex items-center gap-4">
                    <!-- Rewind -->
                    <button onclick="restartAudio()" class="text-indigo-200 hover:text-white transition" title="Restart">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <!-- Main Play Button (Desktop) -->
                    <button onclick="togglePlay()" class="hidden md:flex w-12 h-12 bg-white text-indigo-700 rounded-full shadow-lg items-center justify-center hover:scale-105 transition hover:shadow-white/20">
                        <i class="fas fa-play text-xl ml-1" id="main-play-icon"></i>
                    </button>

                    <!-- Visualizer -->
                    <div class="equalizer" id="visualizer">
                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                    </div>
                </div>

                <!-- Right: Settings -->
                <div class="flex items-center gap-2 text-sm w-full md:w-auto justify-center md:justify-end border-t md:border-t-0 border-indigo-600 pt-2 md:pt-0 mt-2 md:mt-0">
                    <!-- Toggle Text -->
                    <button onclick="toggleText()" id="toggle-text-btn" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded-lg font-bold transition shadow">
                        <i class="fas fa-eye-slash"></i> <span>Hide Text</span>
                    </button>
                </div>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-indigo-900 h-1.5">
            <div id="progress-bar" class="h-full bg-amber-400 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-3xl mx-auto p-4 md:p-6 space-y-8">
        
        <!-- Image Card -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
             <!-- Increased height for better photo visibility (h-64 to md:h-80) -->
             <div class="w-full h-64 md:h-80 bg-gray-200 relative overflow-hidden group">
                <!-- 
                    Updated to use Real Image 
                    src: Points to your local file "images/background.jpg"
                    onerror: Fallback to an online image if local file is missing (for preview purposes)
                -->
                <img 
                    src="images/background.jpg" 
                    alt="Racetrack Playa with sailing stones" 
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1519702237-775b06229156?q=80&w=1200&auto=format&fit=crop';"
                >
                
                <!-- Dark Gradient Overlay for better text readability -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent pointer-events-none"></div>

                <div class="absolute bottom-4 left-4 right-4 text-white">
                    <div class="flex items-center gap-2 text-sm font-medium opacity-90 backdrop-blur-sm bg-black/30 w-fit px-3 py-1 rounded-full">
                        <i class="fas fa-camera"></i> Listening Focus: The Mystery of the Sailing Stones
                    </div>
                </div>
            </div>
        </div>

        <!-- Text Content Area -->
        <div class="bg-white rounded-2xl shadow-sm p-6 md:p-8 border border-gray-200 relative">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 pb-4 border-b">The Mystery of the Sailing Stones</h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 text-sm text-blue-700">
                <i class="fas fa-info-circle mr-1"></i> <strong>Tip:</strong> Hover over or tap underlined words to see their meaning & part of speech!
            </div>

            <!-- Hidden Message Overlay -->
            <div id="hidden-overlay" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm transition-all">
                <div class="bg-indigo-100 p-6 rounded-full mb-4">
                    <i class="fas fa-ear-listen text-4xl text-indigo-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Listen Carefully</h3>
                <p class="text-gray-600 mb-6 text-center max-w-sm">The text is hidden to challenge your listening skills. Try to answer the questions by listening only!</p>
                <button onclick="toggleText()" class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition shadow-lg">
                    Show Text
                </button>
            </div>

            <!-- Article Container (Sentences will be injected here via JS for control) -->
            <div id="article-display" class="prose max-w-none text-gray-700 text-lg leading-relaxed space-y-4">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- Quiz Area -->
        <div class="bg-white rounded-2xl shadow-sm p-6 md:p-8 border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">
                    <i class="fas fa-pen"></i>
                </span>
                Comprehension Quiz
            </h3>
            
            <form id="quizForm" class="space-y-8">
                <!-- Questions will be generated here -->
            </form>

            <div class="mt-8 pt-6 border-t border-gray-100 flex flex-col items-center">
                <!-- Changed Button Functionality -->
                <button type="button" onclick="showFinalScore()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 active:scale-95">
                    Show Final Score
                </button>
                
                <div id="score-card" class="hidden mt-6 text-center w-full bg-indigo-50 p-6 rounded-xl border border-indigo-100 animate-fade-in">
                    <p class="text-gray-500 text-sm uppercase font-bold tracking-wider">Your Result</p>
                    <div class="text-5xl font-extrabold text-indigo-600 my-2" id="final-score">0</div>
                    <p id="feedback-msg" class="text-gray-700 font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Text Data (Invisible) -->
    <div id="raw-text" class="hidden">
        In a quiet corner of Death Valley, California, there is a very strange place called Racetrack Playa. It is a dry, flat lakebed surrounded by mountains. For many years, this place held a big secret. Visitors noticed heavy rocks on the ground with long trails behind them. It looked like the rocks had moved by themselves across the desert floor. Some trails were straight, while others were curved. However, nobody had ever actually seen the rocks move.

        This phenomenon puzzled scientists for decades. How could heavy stones travel hundreds of meters without any help? People had many wild ideas. Some thought aliens were moving them. Others believed it was caused by magnetism or powerful winds. But without proof, the sailing stones remained a mystery.

        Finally, in 2014, a team of scientists led by Richard Norris solved the puzzle. They put GPS devices on some rocks and set up cameras. They waited patiently. One winter day, the perfect conditions arrived. First, rain filled the dry lakebed with a shallow layer of water. At night, the water froze into thin sheets of ice. When the sun came out the next morning, the ice began to break into large floating panels.

        Then, a light wind began to blow. The wind pushed the thin ice sheets against the rocks. The ice acted like a boat, and the wet mud was slippery. The rocks slowly slid across the mud, leaving deep trails behind them. By noon, the ice melted, and the water dried up, leaving only the rocks and their tracks.

        The mystery was solved. It wasn't magic or aliens; it was a rare mix of rain, ice, wind, and sun. Nature is truly full of surprises!
    </div>

    <script>
        // --- Data & State ---
        const quizData = [
            { id: 'q1', q: "1. What is the main idea of the article?", options: {A: "How to visit Death Valley safely.", B: "The history of aliens in California.", C: "How scientists solved the mystery of the moving rocks.", D: "Why rocks are heavy and dangerous."}, ans: 'C', expl: "文章主旨是科學家如何解開石頭移動之謎。" },
            { id: 'q2', q: "2. Where is Racetrack Playa located?", options: {A: "In Death Valley, California.", B: "On a snowy mountain top.", C: "Under the ocean.", D: "In a busy city."}, ans: 'A', expl: "第一句提到位於 Death Valley, California。" },
            { id: 'q3', q: "3. What does the word 'phenomenon' mean?", options: {A: "A scary monster.", B: "A scientific machine.", C: "An observable event or fact.", D: "A type of rock."}, ans: 'C', expl: "Phenomenon 意指「現象」，尤指不尋常的事件。" },
            { id: 'q4', q: "4. Why was it a mystery for so long?", options: {A: "Because the rocks were invisible.", B: "Because the trails disappeared.", C: "Because nobody had ever seen them move.", D: "Scientists were afraid."}, ans: 'C', expl: "文中提到 nobody had ever actually seen the rocks move。" },
            { id: 'q5', q: "5. Which was NOT a guess people made?", options: {A: "Aliens moved them.", B: "Magnetism caused it.", C: "Powerful winds pushed them.", D: "Bears carried them."}, ans: 'D', expl: "文中未提及 Bears (熊)。" },
            { id: 'q6', q: "6. What technology was used?", options: {A: "GPS devices and cameras.", B: "Drones and robots.", C: "Magnets and ropes.", D: "Satellites only."}, ans: 'A', expl: "科學家使用了 GPS 裝置和相機。" },
            { id: 'q7', q: "7. Which conditions are needed?", options: {A: "Heavy rain and storms.", B: "Dry ground and no wind.", C: "Shallow water, ice, sun, and light wind.", D: "Earthquakes."}, ans: 'C', expl: "需要淺水、薄冰、陽光和微風的罕見組合。" },
            { id: 'q8', q: "8. How did the ice help?", options: {A: "It made rocks lighter.", B: "It pushed the rocks with the wind.", C: "It turned into a river.", D: "It froze the rocks down."}, ans: 'B', expl: "冰層像帆船一樣受風推動，進而推動石頭。" },
            { id: 'q9', q: "9. The lakebed is usually __________.", options: {A: "Full of water.", B: "Covered in grass.", C: "Dry and flat.", D: "Full of trees."}, ans: 'C', expl: "文中描述為 dry, flat lakebed。" },
            { id: 'q10', q: "10. How does the author feel?", options: {A: "Disappointed.", B: "Angry.", C: "Impressed by nature.", D: "Confused."}, ans: 'C', expl: "結尾 Nature is truly full of surprises 表達了讚嘆。" }
        ];

        // Extended Vocabulary Dictionary with Part of Speech (POS)
        const vocabulary = {
            "quiet": { pos: "adj.", trans: "安靜的" },
            "corner": { pos: "n.", trans: "角落" },
            "strange": { pos: "adj.", trans: "奇怪的" },
            "place": { pos: "n.", trans: "地方" },
            "dry": { pos: "adj.", trans: "乾的" },
            "flat": { pos: "adj.", trans: "平坦的" },
            "lakebed": { pos: "n.", trans: "湖床" },
            "surrounded": { pos: "v.", trans: "圍繞" },
            "mountains": { pos: "n.", trans: "山脈" },
            "secret": { pos: "n.", trans: "秘密" },
            "visitors": { pos: "n.", trans: "遊客" },
            "noticed": { pos: "v.", trans: "注意到" },
            "heavy": { pos: "adj.", trans: "沉重的" },
            "rocks": { pos: "n.", trans: "岩石" },
            "trails": { pos: "n.", trans: "痕跡" },
            "moved": { pos: "v.", trans: "移動" },
            "desert": { pos: "n.", trans: "沙漠" },
            "floor": { pos: "n.", trans: "地面" },
            "straight": { pos: "adj.", trans: "直的" },
            "curved": { pos: "adj.", trans: "彎曲的" },
            "actually": { pos: "adv.", trans: "實際上" },
            "phenomenon": { pos: "n.", trans: "現象" },
            "puzzled": { pos: "v.", trans: "困惑" },
            "scientists": { pos: "n.", trans: "科學家" },
            "decades": { pos: "n.", trans: "數十年" },
            "travel": { pos: "v.", trans: "移動" },
            "hundreds": { pos: "n.", trans: "數百" },
            "meters": { pos: "n.", trans: "公尺" },
            "ideas": { pos: "n.", trans: "想法" },
            "aliens": { pos: "n.", trans: "外星人" },
            "magnetism": { pos: "n.", trans: "磁力" },
            "powerful": { pos: "adj.", trans: "強大的" },
            "winds": { pos: "n.", trans: "風" },
            "proof": { pos: "n.", trans: "證據" },
            "sailing": { pos: "n/adj", trans: "航行" },
            "mystery": { pos: "n.", trans: "謎團" },
            "solved": { pos: "v.", trans: "解決" },
            "puzzle": { pos: "n.", trans: "謎題" },
            "devices": { pos: "n.", trans: "裝置" },
            "cameras": { pos: "n.", trans: "相機" },
            "patiently": { pos: "adv.", trans: "耐心地" },
            "conditions": { pos: "n.", trans: "條件" },
            "arrived": { pos: "v.", trans: "到達" },
            "shallow": { pos: "adj.", trans: "淺的" },
            "layer": { pos: "n.", trans: "層" },
            "froze": { pos: "v.", trans: "結冰" },
            "thin": { pos: "adj.", trans: "薄的" },
            "sheets": { pos: "n.", trans: "片" },
            "ice": { pos: "n.", trans: "冰" },
            "floating": { pos: "adj.", trans: "漂浮的" },
            "panels": { pos: "n.", trans: "板塊" },
            "pushed": { pos: "v.", trans: "推動" },
            "boat": { pos: "n.", trans: "船" },
            "slippery": { pos: "adj.", trans: "滑的" },
            "slid": { pos: "v.", trans: "滑動" },
            "melted": { pos: "v.", trans: "融化" },
            "dried": { pos: "v.", trans: "變乾" },
            "tracks": { pos: "n.", trans: "軌跡" },
            "magic": { pos: "n.", trans: "魔法" },
            "rare": { pos: "adj.", trans: "罕見的" },
            "mix": { pos: "n.", trans: "混合" },
            "nature": { pos: "n.", trans: "大自然" },
            "surprises": { pos: "n.", trans: "驚喜" }
        };

        let synth = window.speechSynthesis;
        let sentences = [];
        let currentSentenceIndex = 0;
        let isPlaying = false;
        let textHidden = false;
        let selectedVoice = null;
        let userScore = 0; // Track score in real-time
        
        // Setup sound effects
        const correctSound = new Audio('sounds/correct.mp3');
        const failSound = new Audio('sounds/fail.mp3');

        // --- Initialization ---
        window.onload = function() {
            renderArticle();
            renderQuiz();
            initVoice();
        };

        // --- Advanced TTS Logic ---

        function initVoice() {
            const voiceStatus = document.getElementById('voice-indicator');
            
            // Wait for voices to load (Chrome quirk)
            let attempts = 0;
            const loadVoices = () => {
                const voices = synth.getVoices();
                if (voices.length > 0) {
                    selectedVoice = voices.find(v => v.name === 'Google US English') || 
                                    voices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural') && v.lang.includes('en-US')) ||
                                    voices.find(v => v.name.includes('Samantha')) || 
                                    voices.find(v => v.lang === 'en-US');
                    
                    if (selectedVoice) {
                        voiceStatus.innerHTML = `<i class="fas fa-check-circle text-green-300"></i> Voice Ready: ${selectedVoice.name.replace('Microsoft', '').replace('Google', '').substring(0, 15)}...`;
                    } else {
                        voiceStatus.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-300"></i> Standard Voice`;
                    }
                } else if (attempts < 10) {
                    attempts++;
                    setTimeout(loadVoices, 100);
                }
            };
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function renderArticle() {
            const rawText = document.getElementById('raw-text').innerText;
            const segmenter = new Intl.Segmenter('en', { granularity: 'sentence' });
            const segments = segmenter.segment(rawText);
            
            const displayArea = document.getElementById('article-display');
            displayArea.innerHTML = '';
            
            let p = document.createElement('p');
            displayArea.appendChild(p);
            
            let count = 0;
            for (const {segment} of segments) {
                const cleanSegment = segment.trim();
                if (cleanSegment.length > 0) {
                    const span = document.createElement('span');
                    
                    // Process words for dictionary lookup
                    span.innerHTML = processWords(cleanSegment);
                    
                    span.id = `sent-${count}`;
                    span.className = 'cursor-pointer hover:bg-gray-100 rounded transition leading-loose';
                    span.onclick = (e) => {
                        // Prevent playing if user clicked a vocab tooltip
                        if (e.target.classList.contains('vocab-word') || e.target.parentElement.classList.contains('vocab-word')) return;
                        playFromSentence(parseInt(span.id.split('-')[1]));
                    };
                    
                    if(count > 0 && count % 5 === 0) {
                         p = document.createElement('p');
                         displayArea.appendChild(p);
                    }
                    
                    p.appendChild(span);
                    sentences.push({ text: cleanSegment, id: `sent-${count}` });
                    count++;
                }
            }
        }

        // Wrap words with definitions in a span
        function processWords(text) {
            const words = text.split(' ');
            return words.map(word => {
                const cleanWord = word.replace(/[.,!?;:()"]/g, "").toLowerCase();
                const originalWord = word;
                
                if (vocabulary[cleanWord]) {
                    const data = vocabulary[cleanWord];
                    return `<span class="vocab-word" onclick="showDef(event)">${originalWord}<span class="vocab-tooltip"><span class="pos-tag">${data.pos}</span>${data.trans}</span></span>`;
                }
                return originalWord;
            }).join(' ');
        }
        
        function showDef(e) {
            e.stopPropagation();
        }

        function togglePlay() {
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        function playAudio() {
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            
            if (currentSentenceIndex >= sentences.length) {
                currentSentenceIndex = 0;
            }
            speakSentence(currentSentenceIndex);
        }

        function speakSentence(index) {
            if (!isPlaying || index >= sentences.length) {
                if (index >= sentences.length) {
                    isPlaying = false;
                    updatePlayBtn(false);
                    document.getElementById('visualizer').classList.remove('playing');
                    currentSentenceIndex = 0;
                    highlightSentence(-1);
                }
                return;
            }

            currentSentenceIndex = index;
            highlightSentence(index);
            updateProgressBar();

            synth.cancel();

            const text = sentences[index].text;
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 1.0; 
            utterance.pitch = 1.05; 
            
            utterance.onend = function() {
                if (isPlaying) {
                    setTimeout(() => {
                        speakSentence(index + 1);
                    }, 400); 
                }
            };
            
            utterance.onerror = function(e) {
                console.error("Speech error", e);
                isPlaying = false;
                updatePlayBtn(false);
            };

            synth.speak(utterance);
        }

        function pauseAudio() {
            isPlaying = false;
            synth.cancel();
            updatePlayBtn(false);
            document.getElementById('visualizer').classList.remove('playing');
        }

        function restartAudio() {
            synth.cancel();
            currentSentenceIndex = 0;
            updateProgressBar();
            highlightSentence(-1);
            if (isPlaying) {
                setTimeout(() => speakSentence(0), 100);
            }
        }
        
        function playFromSentence(index) {
            currentSentenceIndex = index;
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            speakSentence(index);
        }

        function updatePlayBtn(isPlay) {
            const icons = [document.getElementById('main-play-icon'), document.getElementById('mobile-play-icon')];
            icons.forEach(icon => {
                if (isPlay) {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                } else {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                }
            });
        }

        function highlightSentence(index) {
            document.querySelectorAll('.highlight-text').forEach(el => el.classList.remove('highlight-text'));
            
            if (index >= 0 && index < sentences.length) {
                const el = document.getElementById(sentences[index].id);
                if (el) {
                    el.classList.add('highlight-text');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        function updateProgressBar() {
             const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
             document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function toggleText() {
            textHidden = !textHidden;
            const overlay = document.getElementById('hidden-overlay');
            const btn = document.getElementById('toggle-text-btn');
            
            if (textHidden) {
                overlay.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye"></i> <span>Show Text</span>';
                btn.classList.replace('bg-amber-500', 'bg-indigo-500');
                btn.classList.replace('hover:bg-amber-600', 'hover:bg-indigo-600');
            } else {
                overlay.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span>Hide Text</span>';
                btn.classList.replace('bg-indigo-500', 'bg-amber-500');
                btn.classList.replace('hover:bg-indigo-600', 'hover:bg-amber-600');
            }
        }

        // --- Revised Interactive Quiz Logic ---

        function renderQuiz() {
            const form = document.getElementById('quizForm');
            form.innerHTML = '';
            
            quizData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition';
                div.innerHTML = `
                    <p class="font-bold text-gray-800 mb-4 text-lg">${item.q}</p>
                    <div class="space-y-3" id="${item.id}-options">
                        ${Object.keys(item.options).map(key => `
                            <label class="quiz-option flex items-center p-3 rounded-lg cursor-pointer border border-gray-200" id="${item.id}-label-${key}">
                                <input type="radio" name="${item.id}" value="${key}" class="hidden" onclick="checkAnswer('${item.id}', '${key}')">
                                <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 font-bold text-gray-500 transition-colors" id="${item.id}-icon-${key}">
                                    ${key}
                                </div>
                                <span class="text-gray-700 font-medium">${item.options[key]}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div id="${item.id}-expl" class="explanation-box">
                        <p class="font-bold mb-1" id="${item.id}-status"></p>
                        <p>${item.expl}</p>
                    </div>
                `;
                form.appendChild(div);
            });
        }

        function checkAnswer(questionId, selectedKey) {
            const questionObj = quizData.find(q => q.id === questionId);
            if (!questionObj) return;

            const isCorrect = selectedKey === questionObj.ans;
            
            // Disable all inputs for this question to prevent re-answering
            const optionsDiv = document.getElementById(`${questionId}-options`);
            const inputs = optionsDiv.querySelectorAll('input');
            const labels = optionsDiv.querySelectorAll('label');
            
            inputs.forEach(input => input.disabled = true);
            labels.forEach(label => label.classList.add('disabled'));

            // Visual feedback for selected option
            const selectedLabel = document.getElementById(`${questionId}-label-${selectedKey}`);
            const selectedIcon = document.getElementById(`${questionId}-icon-${selectedKey}`);
            
            if (isCorrect) {
                // Play Correct Sound
                correctSound.currentTime = 0;
                correctSound.play().catch(e => console.log("Audio play failed:", e));

                selectedLabel.classList.add('correct');
                selectedIcon.classList.add('border-green-500', 'text-green-600', 'bg-green-100');
                selectedIcon.innerHTML = '<i class="fas fa-check"></i>';
                userScore += 10;
            } else {
                // Play Fail Sound
                failSound.currentTime = 0;
                failSound.play().catch(e => console.log("Audio play failed:", e));

                selectedLabel.classList.add('wrong');
                selectedIcon.classList.add('border-red-500', 'text-red-600', 'bg-red-100');
                selectedIcon.innerHTML = '<i class="fas fa-times"></i>';
                
                // Highlight the correct answer
                const correctLabel = document.getElementById(`${questionId}-label-${questionObj.ans}`);
                const correctIcon = document.getElementById(`${questionId}-icon-${questionObj.ans}`);
                correctLabel.classList.add('correct');
                correctIcon.classList.add('border-green-500', 'text-green-600', 'bg-green-100');
                correctIcon.innerHTML = '<i class="fas fa-check"></i>';
            }

            // Show Explanation
            const explBox = document.getElementById(`${questionId}-expl`);
            const statusText = document.getElementById(`${questionId}-status`);
            
            explBox.style.display = 'block';
            if (isCorrect) {
                explBox.style.borderLeftColor = '#10b981'; // Green border
                statusText.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> Correct!';
                statusText.className = "font-bold mb-1 text-green-700";
            } else {
                explBox.style.borderLeftColor = '#ef4444'; // Red border
                statusText.innerHTML = `<i class="fas fa-times-circle text-red-600"></i> Incorrect. The correct answer is ${questionObj.ans}.`;
                statusText.className = "font-bold mb-1 text-red-700";
            }
        }

        function showFinalScore() {
            const scoreDisplay = document.getElementById('final-score');
            const feedback = document.getElementById('feedback-msg');
            const resultCard = document.getElementById('score-card');
            
            resultCard.classList.remove('hidden');
            scoreDisplay.innerText = `${userScore} / 100`;
            
            // Celebration Effect for Score >= 80
            if (userScore >= 80) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#6366f1', '#fbbf24', '#10b981', '#f472b6']
                });
                
                if (userScore === 100) {
                    setTimeout(() => {
                        confetti({
                            particleCount: 100,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 }
                        });
                        confetti({
                            particleCount: 100,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 }
                        });
                    }, 500);
                    feedback.innerText = "Perfect! Your listening is amazing!";
                } else {
                    feedback.innerText = "Great job! Almost perfect.";
                }
            } else if (userScore >= 60) {
                feedback.innerText = "Good pass. Review the text and try again.";
            } else {
                feedback.innerText = "Don't give up! Listen to the audio a few more times.";
            }
            
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
</body>
</html>